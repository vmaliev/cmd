<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin User Management - IT Support System</title>
    <link rel="stylesheet" href="html.css">
    <style>
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .admin-title {
            font-size: 2.5em;
            color: #2c3e50;
            margin: 0;
        }

        .admin-actions {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .filters-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .filter-group input,
        .filter-group select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .users-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            min-height: 600px;
        }

        .users-list {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .users-list-header {
            background: #34495e;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .users-list-title {
            font-size: 1.2em;
            font-weight: 600;
            margin: 0;
        }

        .users-count {
            background: #3498db;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
        }

        .users-table th,
        .users-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .users-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        .users-table tr:hover {
            background: #f8f9fa;
        }

        .user-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .status-verified {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-unverified {
            background: #fff3cd;
            color: #856404;
        }

        .user-actions {
            display: flex;
            gap: 5px;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .user-details {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }

        .user-details-header {
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .user-details-title {
            font-size: 1.5em;
            color: #2c3e50;
            margin: 0 0 10px 0;
        }

        .user-details-subtitle {
            color: #7f8c8d;
            margin: 0;
        }

        .user-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-group {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .info-value {
            color: #34495e;
            padding: 8px 0;
        }

        .user-tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }

        .tab-button {
            padding: 10px 20px;
            border: none;
            background: none;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            font-weight: 600;
            color: #7f8c8d;
        }

        .tab-button.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .activity-item {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .activity-time {
            font-size: 0.8em;
            color: #7f8c8d;
        }

        .activity-description {
            margin: 5px 0;
            color: #2c3e50;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            padding: 20px;
            background: #f8f9fa;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
        }

        .pagination button:hover {
            background: #e9ecef;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-info {
            color: #6c757d;
            font-size: 0.9em;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .modal-title {
            font-size: 1.5em;
            color: #2c3e50;
            margin: 0;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }

        .close:hover {
            color: #000;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 30px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .bulk-actions {
            background: #e8f4fd;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        .bulk-actions.show {
            display: block;
        }

        .selected-count {
            font-weight: 600;
            color: #2c3e50;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .users-grid {
                grid-template-columns: 1fr;
            }
            
            .admin-header {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }
            
            .admin-actions {
                justify-content: center;
            }
            
            .filters-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Header -->
        <div class="admin-header">
            <h1 class="admin-title">User Management</h1>
            <div class="admin-actions">
                <button class="btn btn-primary" id="addUserBtn">
                    <span>➕</span> Add User
                </button>
                <button class="btn btn-success" id="exportBtn">
                    <span>📊</span> Export
                </button>
                <button class="btn btn-warning" id="importBtn">
                    <span>📥</span> Import
                </button>
                <button class="btn btn-secondary" id="refreshBtn">
                    <span>🔄</span> Refresh
                </button>
                <a href="/" class="btn btn-secondary">
                    <span>🏠</span> Dashboard
                </a>
            </div>
        </div>

        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalUsers">-</div>
                <div class="stat-label">Total Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activeUsers">-</div>
                <div class="stat-label">Active Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="verifiedUsers">-</div>
                <div class="stat-label">Verified Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="recentUsers">-</div>
                <div class="stat-label">New This Week</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters-section">
            <div class="filters-grid">
                <div class="filter-group">
                    <label for="searchInput">Search</label>
                    <input type="text" id="searchInput" placeholder="Search by name or email...">
                </div>
                <div class="filter-group">
                    <label for="roleFilter">Role</label>
                    <select id="roleFilter">
                        <option value="">All Roles</option>
                        <option value="admin">Admin</option>
                        <option value="technician">Technician</option>
                        <option value="user">User</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="statusFilter">Status</label>
                    <select id="statusFilter">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="sortBy">Sort By</label>
                    <select id="sortBy">
                        <option value="created_at">Created Date</option>
                        <option value="name">Name</option>
                        <option value="email">Email</option>
                        <option value="role">Role</option>
                        <option value="last_login">Last Login</option>
                    </select>
                </div>
                <div class="filter-group">
                    <button class="btn btn-primary" id="applyFiltersBtn">Apply Filters</button>
                </div>
            </div>
        </div>

        <!-- Bulk Actions -->
        <div class="bulk-actions" id="bulkActions">
            <div class="selected-count" id="selectedCount">0 users selected</div>
            <div style="margin-top: 10px;">
                <button class="btn btn-warning btn-sm bulk-deactivate-btn" data-status="inactive">Deactivate</button>
                <button class="btn btn-success btn-sm bulk-activate-btn" data-status="active">Activate</button>
                <button class="btn btn-danger btn-sm bulk-delete-btn">Delete</button>
                <button class="btn btn-secondary btn-sm clear-selection-btn">Clear Selection</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="users-grid">
            <!-- Users List -->
            <div class="users-list">
                <div class="users-list-header">
                    <h3 class="users-list-title">Users</h3>
                    <span class="users-count" id="usersCount">0 users</span>
                </div>
                <div id="usersTableContainer">
                    <div class="loading">Loading users...</div>
                </div>
            </div>

            <!-- User Details -->
            <div class="user-details" id="userDetails">
                <div class="user-details-header">
                    <h3 class="user-details-title">User Details</h3>
                    <p class="user-details-subtitle">Select a user to view details</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Create User Modal -->
    <div id="createUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create New User</h3>
                <span class="close close-create-user-modal">&times;</span>
            </div>
            <form id="createUserForm">
                <div class="form-group">
                    <label for="userName">Name *</label>
                    <input type="text" id="userName" required>
                </div>
                <div class="form-group">
                    <label for="userEmail">Email *</label>
                    <input type="email" id="userEmail" required>
                </div>
                <div class="form-group">
                    <label for="userRole">Role *</label>
                    <select id="userRole" required>
                        <option value="">Select Role</option>
                        <option value="admin">Admin</option>
                        <option value="technician">Technician</option>
                        <option value="user">User</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="userPassword">Password</label>
                    <input type="password" id="userPassword" placeholder="Leave blank for OTP-only login">
                </div>
                <div class="form-group">
                    <label for="userDepartment">Department</label>
                    <input type="text" id="userDepartment">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary cancel-create-user-btn">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create User</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit User</h3>
                <span class="close close-edit-user-modal">&times;</span>
            </div>
            <form id="editUserForm">
                <input type="hidden" id="editUserId">
                <div class="form-group">
                    <label for="editUserName">Name *</label>
                    <input type="text" id="editUserName" required>
                </div>
                <div class="form-group">
                    <label for="editUserEmail">Email *</label>
                    <input type="email" id="editUserEmail" required>
                </div>
                <div class="form-group">
                    <label for="editUserRole">Role *</label>
                    <select id="editUserRole" required>
                        <option value="">Select Role</option>
                        <option value="admin">Admin</option>
                        <option value="technician">Technician</option>
                        <option value="user">User</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editUserDepartment">Department</label>
                    <input type="text" id="editUserDepartment">
                </div>
                <div class="form-group">
                    <label for="editUserActive">Status</label>
                    <select id="editUserActive">
                        <option value="true">Active</option>
                        <option value="false">Inactive</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary cancel-edit-user-btn">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update User</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Import Users Modal -->
    <div id="importUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Import Users</h3>
                <span class="close close-import-user-modal">&times;</span>
            </div>
            <div class="form-group">
                <label for="importFile">Select CSV File</label>
                <input type="file" id="importFile" accept=".csv" required>
                <small style="color: #666; margin-top: 5px; display: block;">
                    CSV should have columns: Name, Email, Role, Department (optional), Status (optional)<br>
                    <a href="/api/users/export?format=csv" download>Download sample CSV</a>
                </small>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="importSkipDuplicates" checked>
                    Skip duplicate emails (recommended)
                </label>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="importSendWelcome" checked>
                    Send welcome emails to new users
                </label>
            </div>
            <div id="importPreview" style="display: none;">
                <h4>Preview (first 5 rows):</h4>
                <div id="importPreviewContent" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background: #f9f9f9;"></div>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary cancel-import-user-btn">Cancel</button>
                <button type="button" class="btn btn-primary" id="importSubmitBtn" disabled>Import Users</button>
            </div>
        </div>
    </div>

    <script>
        let currentUsers = [];
        let selectedUsers = new Set();
        let currentPage = 1;
        let totalPages = 1;
        let currentFilters = {};

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            loadUsers();
            loadStats();
            setupEventListeners();
            // Add event listeners for main buttons
            document.getElementById('addUserBtn').addEventListener('click', showCreateUserModal);
            document.getElementById('exportBtn').addEventListener('click', exportUsers);
            document.getElementById('importBtn').addEventListener('click', showImportUserModal);
            document.getElementById('refreshBtn').addEventListener('click', refreshData);
            // Add event listeners for sorting
            document.getElementById('sortName').addEventListener('click', () => setSort('name'));
            document.getElementById('sortEmail').addEventListener('click', () => setSort('email'));
            document.getElementById('sortRole').addEventListener('click', () => setSort('role'));
            document.getElementById('sortStatus').addEventListener('click', () => setSort('is_active'));
            document.getElementById('sortLastLogin').addEventListener('click', () => setSort('last_login'));
            // Modal close buttons - moved to setupEventListeners for better reliability
        });

        function setupEventListeners() {
            // Search input
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    applyFilters();
                }
            });

            // Filter dropdowns - apply filters when changed
            document.getElementById('roleFilter').addEventListener('change', applyFilters);
            document.getElementById('statusFilter').addEventListener('change', applyFilters);
            document.getElementById('sortBy').addEventListener('change', applyFilters);

            // Apply filters button
            document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);

            // Form submissions
            document.getElementById('createUserForm').addEventListener('submit', createUser);
            document.getElementById('editUserForm').addEventListener('submit', updateUser);
            
            // Import button
            document.getElementById('importSubmitBtn').addEventListener('click', importUsers);
            
            // Click outside modal to close
            window.addEventListener('click', function(event) {
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    if (event.target === modal) {
                        console.log('Clicking outside modal to close:', modal.id);
                        closeModal(modal.id);
                    }
                });
            });
            
            // Modal close buttons (X buttons)
            const closeCreateBtn = document.querySelector('.close-create-user-modal');
            if (closeCreateBtn) {
                closeCreateBtn.addEventListener('click', function() {
                    console.log('Closing create user modal');
                    closeModal('createUserModal');
                    document.getElementById('createUserForm').reset();
                });
            } else {
                console.error('Close create user modal button not found');
            }
            
            const closeEditBtn = document.querySelector('.close-edit-user-modal');
            if (closeEditBtn) {
                closeEditBtn.addEventListener('click', function() {
                    console.log('Closing edit user modal');
                    closeModal('editUserModal');
                });
            } else {
                console.error('Close edit user modal button not found');
            }
            
            const closeImportBtn = document.querySelector('.close-import-user-modal');
            if (closeImportBtn) {
                closeImportBtn.addEventListener('click', function() {
                    console.log('Closing import user modal');
                    closeModal('importUserModal');
                    document.getElementById('importFile').value = '';
                    document.getElementById('importPreview').style.display = 'none';
                    document.getElementById('importSubmitBtn').disabled = true;
                });
            } else {
                console.error('Close import user modal button not found');
            }
            
            // Modal cancel buttons
            const cancelCreateBtn = document.querySelector('.cancel-create-user-btn');
            if (cancelCreateBtn) {
                cancelCreateBtn.addEventListener('click', function() {
                    console.log('Canceling create user modal');
                    closeModal('createUserModal');
                    document.getElementById('createUserForm').reset();
                });
            } else {
                console.error('Cancel create user modal button not found');
            }
            
            const cancelEditBtn = document.querySelector('.cancel-edit-user-btn');
            if (cancelEditBtn) {
                cancelEditBtn.addEventListener('click', function() {
                    console.log('Canceling edit user modal');
                    closeModal('editUserModal');
                });
            } else {
                console.error('Cancel edit user modal button not found');
            }
            
            const cancelImportBtn = document.querySelector('.cancel-import-user-btn');
            if (cancelImportBtn) {
                cancelImportBtn.addEventListener('click', function() {
                    console.log('Canceling import user modal');
                    closeModal('importUserModal');
                    document.getElementById('importFile').value = '';
                    document.getElementById('importPreview').style.display = 'none';
                    document.getElementById('importSubmitBtn').disabled = true;
                });
            } else {
                console.error('Cancel import user modal button not found');
            }
        }

        function addTableEventListeners() {
            // Select all checkbox
            const selectAllCheckbox = document.getElementById('selectAll');
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', toggleSelectAll);
            }

            // Individual user checkboxes
            const userCheckboxes = document.querySelectorAll('input[type="checkbox"][data-user-id]');
            userCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const userId = parseInt(this.getAttribute('data-user-id'));
                    toggleUserSelection(userId);
                });
            });

            // View buttons
            const viewButtons = document.querySelectorAll('.view-user-btn');
            viewButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const userId = parseInt(this.getAttribute('data-user-id'));
                    viewUser(userId);
                });
            });

            // Edit buttons
            const editButtons = document.querySelectorAll('.edit-user-btn');
            editButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const userId = parseInt(this.getAttribute('data-user-id'));
                    editUser(userId);
                });
            });

            // Delete buttons
            const deleteButtons = document.querySelectorAll('.delete-user-btn');
            deleteButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const userId = parseInt(this.getAttribute('data-user-id'));
                    deleteUser(userId);
                });
            });
        }

        function addPaginationEventListeners() {
            // Previous page button
            const prevButton = document.querySelector('.prev-page-btn');
            if (prevButton) {
                prevButton.addEventListener('click', function() {
                    const page = parseInt(this.getAttribute('data-page'));
                    changePage(page);
                });
            }

            // Next page button
            const nextButton = document.querySelector('.next-page-btn');
            if (nextButton) {
                nextButton.addEventListener('click', function() {
                    const page = parseInt(this.getAttribute('data-page'));
                    changePage(page);
                });
            }
        }

        function addBulkActionEventListeners() {
            // Bulk deactivate button
            const deactivateBtn = document.querySelector('.bulk-deactivate-btn');
            if (deactivateBtn) {
                deactivateBtn.addEventListener('click', function() {
                    const status = this.getAttribute('data-status');
                    bulkUpdateStatus(status);
                });
            }

            // Bulk activate button
            const activateBtn = document.querySelector('.bulk-activate-btn');
            if (activateBtn) {
                activateBtn.addEventListener('click', function() {
                    const status = this.getAttribute('data-status');
                    bulkUpdateStatus(status);
                });
            }

            // Bulk delete button
            const deleteBtn = document.querySelector('.bulk-delete-btn');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', bulkDelete);
            }

            // Clear selection button
            const clearBtn = document.querySelector('.clear-selection-btn');
            if (clearBtn) {
                clearBtn.addEventListener('click', clearSelection);
            }
        }

        function addTabEventListeners() {
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    switchTab(tabName);
                });
            });
        }

        async function loadUsers() {
            try {
                const response = await fetch('/api/users?' + new URLSearchParams({
                    page: currentPage,
                    limit: 20,
                    ...currentFilters
                }));
                
                if (!response.ok) throw new Error('Failed to load users');
                
                const data = await response.json();
                currentUsers = data.users;
                totalPages = data.pagination.totalPages;
                
                renderUsersTable();
                updatePagination();
            } catch (error) {
                console.error('Error loading users:', error);
                showError('Failed to load users');
            }
        }

        async function loadStats() {
            try {
                const response = await fetch('/api/users/stats');
                if (!response.ok) throw new Error('Failed to load stats');
                
                const stats = await response.json();
                
                document.getElementById('totalUsers').textContent = stats.total;
                document.getElementById('activeUsers').textContent = stats.active;
                document.getElementById('verifiedUsers').textContent = stats.verified;
                document.getElementById('recentUsers').textContent = stats.recentRegistrations;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        function renderUsersTable() {
            const container = document.getElementById('usersTableContainer');
            const count = document.getElementById('usersCount');
            
            if (currentUsers.length === 0) {
                container.innerHTML = '<div class="loading">No users found</div>';
                count.textContent = '0 users';
                return;
            }

            let html = `
                <table class="users-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAll"></th>
                            <th id="sortName">Name</th>
                            <th id="sortEmail">Email</th>
                            <th id="sortRole">Role</th>
                            <th id="sortStatus">Status</th>
                            <th id="sortLastLogin">Last Login</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            currentUsers.forEach(user => {
                const isSelected = selectedUsers.has(user.id);
                html += `
                    <tr>
                        <td>
                            <input type="checkbox" value="${user.id}" 
                                   ${isSelected ? 'checked' : ''} 
                                   data-user-id="${user.id}">
                        </td>
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td><span class="user-status status-${user.role}">${user.role}</span></td>
                        <td>
                            <span class="user-status ${user.is_active ? 'status-active' : 'status-inactive'}">
                                ${user.is_active ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td>${user.last_login ? new Date(user.last_login).toLocaleDateString() : 'Never'}</td>
                        <td>
                            <div class="user-actions">
                                <button class="btn btn-primary btn-sm view-user-btn" data-user-id="${user.id}">View</button>
                                <button class="btn btn-warning btn-sm edit-user-btn" data-user-id="${user.id}">Edit</button>
                                <button class="btn btn-danger btn-sm delete-user-btn" data-user-id="${user.id}">Delete</button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
            count.textContent = `${currentUsers.length} users`;
            
            updateBulkActions();
            
            // Add event listeners after rendering
            addTableEventListeners();
        }

        function updatePagination() {
            const container = document.getElementById('usersTableContainer');
            const pagination = document.createElement('div');
            pagination.className = 'pagination';
            
            pagination.innerHTML = `
                <button class="prev-page-btn" data-page="${currentPage - 1}" ${currentPage <= 1 ? 'disabled' : ''}>
                    Previous
                </button>
                <span class="pagination-info">
                    Page ${currentPage} of ${totalPages}
                </span>
                <button class="next-page-btn" data-page="${currentPage + 1}" ${currentPage >= totalPages ? 'disabled' : ''}>
                    Next
                </button>
            `;
            
            container.appendChild(pagination);
            
            // Add pagination event listeners
            addPaginationEventListeners();
        }

        function changePage(page) {
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                loadUsers();
            }
        }

        function applyFilters() {
            currentFilters = {
                search: document.getElementById('searchInput').value,
                role: document.getElementById('roleFilter').value,
                status: document.getElementById('statusFilter').value,
                sortBy: document.getElementById('sortBy').value,
                sortOrder: 'desc'
            };
            
            currentPage = 1;
            loadUsers();
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('input[type="checkbox"][value]');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
                if (selectAll.checked) {
                    selectedUsers.add(parseInt(checkbox.value));
                } else {
                    selectedUsers.delete(parseInt(checkbox.value));
                }
            });
            
            updateBulkActions();
        }

        function toggleUserSelection(userId) {
            if (selectedUsers.has(userId)) {
                selectedUsers.delete(userId);
            } else {
                selectedUsers.add(userId);
            }
            updateBulkActions();
        }

        function updateBulkActions() {
            const bulkActions = document.getElementById('bulkActions');
            const selectedCount = document.getElementById('selectedCount');
            
            if (selectedUsers.size > 0) {
                bulkActions.classList.add('show');
                selectedCount.textContent = `${selectedUsers.size} users selected`;
                // Add bulk action event listeners
                addBulkActionEventListeners();
            } else {
                bulkActions.classList.remove('show');
            }
        }

        function clearSelection() {
            selectedUsers.clear();
            document.getElementById('selectAll').checked = false;
            document.querySelectorAll('input[type="checkbox"][value]').forEach(cb => cb.checked = false);
            updateBulkActions();
        }

        async function viewUser(userId) {
            try {
                const response = await fetch(`/api/users/${userId}`);
                if (!response.ok) throw new Error('Failed to load user details');
                
                const userData = await response.json();
                renderUserDetails(userData);
            } catch (error) {
                console.error('Error loading user details:', error);
                showError('Failed to load user details');
            }
        }

        function renderUserDetails(userData) {
            const container = document.getElementById('userDetails');
            
            container.innerHTML = `
                <div class="user-details-header">
                    <h3 class="user-details-title">${userData.user.name}</h3>
                    <p class="user-details-subtitle">${userData.user.email}</p>
                </div>
                
                <div class="user-info-grid">
                    <div class="info-group">
                        <div class="info-label">Role</div>
                        <div class="info-value">${userData.user.role}</div>
                    </div>
                    <div class="info-group">
                        <div class="info-label">Status</div>
                        <div class="info-value">
                            <span class="user-status ${userData.user.is_active ? 'status-active' : 'status-inactive'}">
                                ${userData.user.is_active ? 'Active' : 'Inactive'}
                            </span>
                        </div>
                    </div>
                    <div class="info-group">
                        <div class="info-label">Verified</div>
                        <div class="info-value">
                            <span class="user-status ${userData.user.is_verified ? 'status-verified' : 'status-unverified'}">
                                ${userData.user.is_verified ? 'Verified' : 'Unverified'}
                            </span>
                        </div>
                    </div>
                    <div class="info-group">
                        <div class="info-label">Department</div>
                        <div class="info-value">${userData.user.department || 'Not specified'}</div>
                    </div>
                    <div class="info-group">
                        <div class="info-label">Created</div>
                        <div class="info-value">${new Date(userData.user.created_at).toLocaleDateString()}</div>
                    </div>
                    <div class="info-group">
                        <div class="info-label">Last Login</div>
                        <div class="info-value">${userData.user.last_login ? new Date(userData.user.last_login).toLocaleDateString() : 'Never'}</div>
                    </div>
                </div>
                
                <div class="user-tabs">
                    <button class="tab-button active" data-tab="activity">Recent Activity</button>
                    <button class="tab-button" data-tab="permissions">Permissions</button>
                </div>
                
                <div id="activityTab" class="tab-content active">
                    ${renderActivityTab(userData.recentActivity)}
                </div>
                
                <div id="permissionsTab" class="tab-content">
                    ${renderPermissionsTab(userData.permissions)}
                </div>
            `;
            
            // Add tab event listeners
            addTabEventListeners();
        }

        function renderActivityTab(activity) {
            if (!activity || activity.length === 0) {
                return '<p>No recent activity</p>';
            }
            
            return activity.map(item => `
                <div class="activity-item">
                    <div class="activity-time">${new Date(item.created_at).toLocaleString()}</div>
                    <div class="activity-description">${item.activity_description}</div>
                </div>
            `).join('');
        }

        function renderPermissionsTab(permissions) {
            if (!permissions || permissions.length === 0) {
                return '<p>No permissions found</p>';
            }
            
            return permissions.map(permission => `
                <div class="activity-item">
                    <div class="activity-description">${permission.permission_name}</div>
                </div>
            `).join('');
        }

        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
        }

        function showCreateUserModal() {
            document.getElementById('createUserModal').style.display = 'block';
        }

        function editUser(userId) {
            const user = currentUsers.find(u => u.id === userId);
            if (!user) return;
            
            document.getElementById('editUserId').value = user.id;
            document.getElementById('editUserName').value = user.name;
            document.getElementById('editUserEmail').value = user.email;
            document.getElementById('editUserRole').value = user.role;
            document.getElementById('editUserDepartment').value = user.department || '';
            document.getElementById('editUserActive').value = user.is_active.toString();
            
            document.getElementById('editUserModal').style.display = 'block';
        }

        function closeModal(modalId) {
            console.log('Closing modal:', modalId);
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                console.log('Modal closed successfully:', modalId);
            } else {
                console.error('Modal not found:', modalId);
            }
        }

        async function createUser(event) {
            event.preventDefault();
            
            const formData = {
                name: document.getElementById('userName').value,
                email: document.getElementById('userEmail').value,
                role: document.getElementById('userRole').value,
                password: document.getElementById('userPassword').value,
                department: document.getElementById('userDepartment').value
            };
            
            try {
                const response = await fetch('/api/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                if (!response.ok) throw new Error('Failed to create user');
                
                showSuccess('User created successfully');
                closeModal('createUserModal');
                document.getElementById('createUserForm').reset();
                loadUsers();
                loadStats();
            } catch (error) {
                console.error('Error creating user:', error);
                showError('Failed to create user');
            }
        }

        async function updateUser(event) {
            event.preventDefault();
            
            const userId = document.getElementById('editUserId').value;
            const formData = {
                name: document.getElementById('editUserName').value,
                email: document.getElementById('editUserEmail').value,
                role: document.getElementById('editUserRole').value,
                department: document.getElementById('editUserDepartment').value,
                isActive: document.getElementById('editUserActive').value === 'true'
            };
            
            try {
                const response = await fetch(`/api/users/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                if (!response.ok) throw new Error('Failed to update user');
                
                showSuccess('User updated successfully');
                closeModal('editUserModal');
                loadUsers();
                loadStats();
            } catch (error) {
                console.error('Error updating user:', error);
                showError('Failed to update user');
            }
        }

        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user?')) return;
            
            try {
                const response = await fetch(`/api/users/${userId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) throw new Error('Failed to delete user');
                
                showSuccess('User deleted successfully');
                loadUsers();
                loadStats();
            } catch (error) {
                console.error('Error deleting user:', error);
                showError('Failed to delete user');
            }
        }

        async function bulkUpdateStatus(status) {
            if (selectedUsers.size === 0) return;
            
            try {
                const response = await fetch('/api/users/bulk/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userIds: Array.from(selectedUsers),
                        updates: { is_active: status === 'active' }
                    })
                });
                
                if (!response.ok) throw new Error('Failed to update users');
                
                const result = await response.json();
                showSuccess(result.message);
                clearSelection();
                loadUsers();
                loadStats();
            } catch (error) {
                console.error('Error bulk updating users:', error);
                showError('Failed to update users');
            }
        }

        async function bulkDelete() {
            if (selectedUsers.size === 0) return;
            
            if (!confirm(`Are you sure you want to delete ${selectedUsers.size} users?`)) return;
            
            try {
                const response = await fetch('/api/users/bulk/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userIds: Array.from(selectedUsers)
                    })
                });
                
                if (!response.ok) throw new Error('Failed to delete users');
                
                const result = await response.json();
                showSuccess(result.message);
                clearSelection();
                loadUsers();
                loadStats();
            } catch (error) {
                console.error('Error bulk deleting users:', error);
                showError('Failed to delete users');
            }
        }

        async function exportUsers() {
            try {
                const response = await fetch('/api/users/export?format=csv');
                
                if (!response.ok) throw new Error('Failed to export users');
                
                const csv = await response.text();
                downloadCSV(csv, 'users-export.csv');
                showSuccess('Users exported successfully');
            } catch (error) {
                console.error('Error exporting users:', error);
                showError('Failed to export users');
            }
        }

        function showImportUserModal() {
            document.getElementById('importUserModal').style.display = 'block';
            document.getElementById('importFile').value = '';
            document.getElementById('importPreview').style.display = 'none';
            document.getElementById('importSubmitBtn').disabled = true;
            
            // Add file change listener
            document.getElementById('importFile').addEventListener('change', handleFileSelect);
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) {
                document.getElementById('importSubmitBtn').disabled = true;
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const csv = e.target.result;
                const preview = parseCSVPreview(csv);
                
                if (preview.length > 0) {
                    document.getElementById('importPreviewContent').innerHTML = preview;
                    document.getElementById('importPreview').style.display = 'block';
                    document.getElementById('importSubmitBtn').disabled = false;
                } else {
                    showError('Invalid CSV format. Please check your file.');
                    document.getElementById('importSubmitBtn').disabled = true;
                }
            };
            reader.readAsText(file);
        }

        function parseCSVPreview(csv) {
            const lines = csv.split('\n').filter(line => line.trim());
            if (lines.length < 2) return [];
            
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const requiredHeaders = ['Name', 'Email', 'Role'];
            
            // Check if required headers are present
            const hasRequiredHeaders = requiredHeaders.every(header => 
                headers.some(h => h.toLowerCase() === header.toLowerCase())
            );
            
            if (!hasRequiredHeaders) return [];
            
            // Parse first 5 data rows
            const previewRows = lines.slice(1, 6).map(line => {
                const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
                return `<div style="margin-bottom: 5px; padding: 5px; border-bottom: 1px solid #eee;">
                    <strong>${values[0] || 'N/A'}</strong> (${values[1] || 'N/A'}) - ${values[2] || 'N/A'}
                </div>`;
            }).join('');
            
            return previewRows;
        }

        async function importUsers() {
            const file = document.getElementById('importFile').files[0];
            if (!file) return;
            
            const skipDuplicates = document.getElementById('importSkipDuplicates').checked;
            const sendWelcome = document.getElementById('importSendWelcome').checked;
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('skipDuplicates', skipDuplicates);
                formData.append('sendWelcome', sendWelcome);
                
                const response = await fetch('/api/users/import', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to import users');
                }
                
                const result = await response.json();
                showSuccess(`Import completed: ${result.imported} users imported, ${result.skipped} skipped`);
                closeModal('importUserModal');
                loadUsers();
                loadStats();
            } catch (error) {
                console.error('Error importing users:', error);
                showError(error.message || 'Failed to import users');
            }
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function refreshData() {
            loadUsers();
            loadStats();
        }

        function showSuccess(message) {
            const div = document.createElement('div');
            div.className = 'success-message';
            div.textContent = message;
            document.querySelector('.admin-container').insertBefore(div, document.querySelector('.stats-grid'));
            
            setTimeout(() => div.remove(), 5000);
        }

        function showError(message) {
            const div = document.createElement('div');
            div.className = 'error-message';
            div.textContent = message;
            document.querySelector('.admin-container').insertBefore(div, document.querySelector('.stats-grid'));
            
            setTimeout(() => div.remove(), 5000);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // Sorting logic
        function setSort(field) {
            if (currentFilters.sortBy === field) {
                currentFilters.sortOrder = currentFilters.sortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                currentFilters.sortBy = field;
                currentFilters.sortOrder = 'asc';
            }
            loadUsers();
        }
    </script>
</body>
</html> 