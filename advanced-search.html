<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Search - IT Support System</title>
    <link rel="stylesheet" href="html.css">
    <style>
        .search-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .search-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }

        .search-header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }

        .search-header p {
            margin: 10px 0 0 0;
            font-size: 1.1em;
            opacity: 0.9;
        }

        .search-grid {
            display: grid;
            grid-template-columns: 1fr 3fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .filters-panel {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            height: fit-content;
        }

        .filters-panel h3 {
            margin: 0 0 20px 0;
            color: #333;
            font-size: 1.3em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .filter-group {
            margin-bottom: 25px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .filter-group input,
        .filter-group select,
        .filter-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .filter-group input:focus,
        .filter-group select:focus,
        .filter-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .filter-group .date-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .filter-group .multi-select {
            min-height: 100px;
        }

        .filter-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #6c757d;
            border: 2px solid #e9ecef;
        }

        .btn-secondary:hover {
            background: #e9ecef;
            color: #495057;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(40, 167, 69, 0.4);
        }

        .results-panel {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .results-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f8f9fa;
        }

        .results-header h3 {
            margin: 0;
            color: #333;
            font-size: 1.3em;
        }

        .results-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            flex: 1;
        }

        .stat-number {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 5px;
        }

        .tickets-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .tickets-table th,
        .tickets-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .tickets-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .tickets-table tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .priority-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .saved-filters {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #f8f9fa;
        }

        .saved-filters h4 {
            margin: 0 0 15px 0;
            color: #333;
        }

        .saved-filter-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .saved-filter-item:hover {
            background: #e9ecef;
        }

        .saved-filter-info {
            flex: 1;
        }

        .saved-filter-name {
            font-weight: 600;
            color: #333;
        }

        .saved-filter-desc {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 2px;
        }

        .saved-filter-actions {
            display: flex;
            gap: 5px;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 0.8em;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .export-options {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }

        @media (max-width: 768px) {
            .search-grid {
                grid-template-columns: 1fr;
            }
            
            .results-header {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }
            
            .export-options {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <div class="search-container">
        <!-- Header -->
        <div class="search-header">
            <h1>üîç Advanced Ticket Search</h1>
            <p>Search and filter tickets with advanced criteria and save your favorite searches</p>
        </div>

        <!-- Main Content -->
        <div class="search-grid">
            <!-- Filters Panel -->
            <div class="filters-panel">
                <h3>üìã Search Filters</h3>
                
                <!-- Text Search -->
                <div class="filter-group">
                    <label for="searchText">Search Text</label>
                    <input type="text" id="searchText" placeholder="Search in subject, description, ticket ID, names...">
                </div>

                <!-- Status Filter -->
                <div class="filter-group">
                    <label for="statusFilter">Status</label>
                    <select id="statusFilter" multiple class="multi-select">
                        <option value="">Loading...</option>
                    </select>
                </div>

                <!-- Priority Filter -->
                <div class="filter-group">
                    <label for="priorityFilter">Priority</label>
                    <select id="priorityFilter" multiple class="multi-select">
                        <option value="">Loading...</option>
                    </select>
                </div>

                <!-- Category Filter -->
                <div class="filter-group">
                    <label for="categoryFilter">Category</label>
                    <select id="categoryFilter" multiple class="multi-select">
                        <option value="">Loading...</option>
                    </select>
                </div>

                <!-- Assignee Filter -->
                <div class="filter-group">
                    <label for="assigneeFilter">Assignee</label>
                    <select id="assigneeFilter">
                        <option value="">All Assignees</option>
                        <option value="unassigned">Unassigned</option>
                    </select>
                </div>

                <!-- Requester Filter -->
                <div class="filter-group">
                    <label for="requesterFilter">Requester</label>
                    <select id="requesterFilter">
                        <option value="">All Requesters</option>
                    </select>
                </div>

                <!-- Department Filter -->
                <div class="filter-group">
                    <label for="departmentFilter">Department</label>
                    <select id="departmentFilter">
                        <option value="">All Departments</option>
                    </select>
                </div>

                <!-- Date Range Filters -->
                <div class="filter-group">
                    <label>Created Date Range</label>
                    <div class="date-inputs">
                        <input type="date" id="createdAfter" placeholder="From">
                        <input type="date" id="createdBefore" placeholder="To">
                    </div>
                </div>

                <div class="filter-group">
                    <label>Updated Date Range</label>
                    <div class="date-inputs">
                        <input type="date" id="updatedAfter" placeholder="From">
                        <input type="date" id="updatedBefore" placeholder="To">
                    </div>
                </div>

                <div class="filter-group">
                    <label>Resolved Date Range</label>
                    <div class="date-inputs">
                        <input type="date" id="resolvedAfter" placeholder="From">
                        <input type="date" id="resolvedBefore" placeholder="To">
                    </div>
                </div>

                <!-- Filter Actions -->
                <div class="filter-actions">
                    <button class="btn btn-primary" onclick="performSearch()">
                        üîç Search
                    </button>
                    <button class="btn btn-secondary" onclick="clearFilters()">
                        üóëÔ∏è Clear
                    </button>
                    <button class="btn btn-success" onclick="saveFilter()">
                        üíæ Save Filter
                    </button>
                </div>

                <!-- Saved Filters -->
                <div class="saved-filters">
                    <h4>üíæ Saved Filters</h4>
                    <div id="savedFiltersList">
                        <div class="loading">Loading saved filters...</div>
                    </div>
                </div>
            </div>

            <!-- Results Panel -->
            <div class="results-panel">
                <div class="results-header">
                    <h3>üìä Search Results</h3>
                    <div class="export-options">
                        <button class="btn btn-secondary" onclick="exportResults('json')">
                            üìÑ Export JSON
                        </button>
                        <button class="btn btn-secondary" onclick="exportResults('csv')">
                            üìä Export CSV
                        </button>
                    </div>
                </div>

                <!-- Statistics -->
                <div class="results-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalTickets">0</div>
                        <div class="stat-label">Total Tickets</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="openTickets">0</div>
                        <div class="stat-label">Open</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="resolvedTickets">0</div>
                        <div class="stat-label">Resolved</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="avgResolution">0h</div>
                        <div class="stat-label">Avg Resolution</div>
                    </div>
                </div>

                <!-- Results Table -->
                <div id="resultsTable">
                    <div class="no-results">
                        Use the filters on the left to search for tickets
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Filter Modal -->
    <div id="saveFilterModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; min-width: 400px;">
            <h3>üíæ Save Search Filter</h3>
            <div style="margin: 20px 0;">
                <label>Filter Name:</label>
                <input type="text" id="filterName" placeholder="Enter filter name" style="width: 100%; padding: 10px; margin-top: 5px; border: 2px solid #e1e5e9; border-radius: 6px;">
            </div>
            <div style="margin: 20px 0;">
                <label>Description (optional):</label>
                <textarea id="filterDescription" placeholder="Enter description" style="width: 100%; padding: 10px; margin-top: 5px; border: 2px solid #e1e5e9; border-radius: 6px; height: 80px;"></textarea>
            </div>
            <div style="margin: 20px 0;">
                <label>
                    <input type="checkbox" id="filterPublic"> Make this filter public
                </label>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeSaveModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmSaveFilter()">Save Filter</button>
            </div>
        </div>
    </div>

    <script>
        let currentFilters = {};
        let filterOptions = {};

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadFilterOptions();
            loadSavedFilters();
        });

        // Load available filter options
        async function loadFilterOptions() {
            try {
                const response = await fetch('/api/advanced-search/filter-options', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    filterOptions = data.options;
                    populateFilterOptions();
                }
            } catch (error) {
                console.error('Error loading filter options:', error);
            }
        }

        // Populate filter dropdowns
        function populateFilterOptions() {
            // Status options
            const statusSelect = document.getElementById('statusFilter');
            statusSelect.innerHTML = '<option value="">All Statuses</option>';
            filterOptions.statuses.forEach(status => {
                const option = document.createElement('option');
                option.value = status.name;
                option.textContent = status.name;
                statusSelect.appendChild(option);
            });

            // Priority options
            const prioritySelect = document.getElementById('priorityFilter');
            prioritySelect.innerHTML = '<option value="">All Priorities</option>';
            filterOptions.priorities.forEach(priority => {
                const option = document.createElement('option');
                option.value = priority.name;
                option.textContent = priority.name;
                prioritySelect.appendChild(option);
            });

            // Category options
            const categorySelect = document.getElementById('categoryFilter');
            categorySelect.innerHTML = '<option value="">All Categories</option>';
            filterOptions.categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.name;
                option.textContent = category.name;
                categorySelect.appendChild(option);
            });

            // Assignee options
            const assigneeSelect = document.getElementById('assigneeFilter');
            assigneeSelect.innerHTML = '<option value="">All Assignees</option><option value="unassigned">Unassigned</option>';
            filterOptions.assignees.forEach(assignee => {
                const option = document.createElement('option');
                option.value =assignee.email;
                option.textContent = `${assignee.name} (${assignee.email})`;
                assigneeSelect.appendChild(option);
            });

            // Requester options
            const requesterSelect = document.getElementById('requesterFilter');
            requesterSelect.innerHTML = '<option value="">All Requesters</option>';
            filterOptions.requesters.forEach(requester => {
                const option = document.createElement('option');
                option.value = requester.email;
                option.textContent = `${requester.name} (${requester.email})`;
                requesterSelect.appendChild(option);
            });

            // Department options
            const departmentSelect = document.getElementById('departmentFilter');
            departmentSelect.innerHTML = '<option value="">All Departments</option>';
            filterOptions.departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept.department;
                option.textContent = dept.department;
                departmentSelect.appendChild(option);
            });
        }

        // Build filters object from form
        function buildFilters() {
            const filters = {};

            // Text search
            const searchText = document.getElementById('searchText').value.trim();
            if (searchText) filters.search = searchText;

            // Status filter
            const statusFilter = document.getElementById('statusFilter');
            const selectedStatuses = Array.from(statusFilter.selectedOptions).map(opt => opt.value).filter(v => v);
            if (selectedStatuses.length > 0) {
                filters.status = selectedStatuses.length === 1 ? selectedStatuses[0] : selectedStatuses;
            }

            // Priority filter
            const priorityFilter = document.getElementById('priorityFilter');
            const selectedPriorities = Array.from(priorityFilter.selectedOptions).map(opt => opt.value).filter(v => v);
            if (selectedPriorities.length > 0) {
                filters.priority = selectedPriorities.length === 1 ? selectedPriorities[0] : selectedPriorities;
            }

            // Category filter
            const categoryFilter = document.getElementById('categoryFilter');
            const selectedCategories = Array.from(categoryFilter.selectedOptions).map(opt => opt.value).filter(v => v);
            if (selectedCategories.length > 0) {
                filters.category = selectedCategories.length === 1 ? selectedCategories[0] : selectedCategories;
            }

            // Assignee filter
            const assigneeFilter = document.getElementById('assigneeFilter').value;
            if (assigneeFilter) filters.assignee = assigneeFilter;

            // Requester filter
            const requesterFilter = document.getElementById('requesterFilter').value;
            if (requesterFilter) filters.requester = requesterFilter;

            // Department filter
            const departmentFilter = document.getElementById('departmentFilter').value;
            if (departmentFilter) filters.department = departmentFilter;

            // Date filters
            const createdAfter = document.getElementById('createdAfter').value;
            if (createdAfter) filters.createdAfter = createdAfter;

            const createdBefore = document.getElementById('createdBefore').value;
            if (createdBefore) filters.createdBefore = createdBefore;

            const updatedAfter = document.getElementById('updatedAfter').value;
            if (updatedAfter) filters.updatedAfter = updatedAfter;

            const updatedBefore = document.getElementById('updatedBefore').value;
            if (updatedBefore) filters.updatedBefore = updatedBefore;

            const resolvedAfter = document.getElementById('resolvedAfter').value;
            if (resolvedAfter) filters.resolvedAfter = resolvedAfter;

            const resolvedBefore = document.getElementById('resolvedBefore').value;
            if (resolvedBefore) filters.resolvedBefore = resolvedBefore;

            return filters;
        }

        // Perform search
        async function performSearch() {
            const filters = buildFilters();
            currentFilters = filters;

            const queryParams = new URLSearchParams();
            Object.entries(filters).forEach(([key, value]) => {
                if (Array.isArray(value)) {
                    value.forEach(v => queryParams.append(key, v));
                } else {
                    queryParams.append(key, value);
                }
            });

            try {
                const response = await fetch(`/api/advanced-search/tickets?${queryParams}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    displayResults(data);
                } else {
                    console.error('Search failed:', response.statusText);
                }
            } catch (error) {
                console.error('Error performing search:', error);
            }
        }

        // Display search results
        function displayResults(data) {
            const { tickets, stats } = data;

            // Update statistics
            document.getElementById('totalTickets').textContent = stats.total_tickets || 0;
            document.getElementById('openTickets').textContent = stats.open_tickets || 0;
            document.getElementById('resolvedTickets').textContent = stats.resolved_tickets || 0;
            document.getElementById('avgResolution').textContent = 
                stats.avg_resolution_hours ? `${Math.round(stats.avg_resolution_hours)}h` : '0h';

            // Update results table
            const resultsTable = document.getElementById('resultsTable');
            
            if (tickets.length === 0) {
                resultsTable.innerHTML = '<div class="no-results">No tickets found matching your criteria</div>';
                return;
            }

            let tableHTML = `
                <table class="tickets-table">
                    <thead>
                        <tr>
                            <th>Ticket ID</th>
                            <th>Subject</th>
                            <th>Status</th>
                            <th>Priority</th>
                            <th>Category</th>
                            <th>Requester</th>
                            <th>Assignee</th>
                            <th>Created</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            tickets.forEach(ticket => {
                const statusClass = ticket.status_name?.toLowerCase().replace(' ', '-') || '';
                const priorityClass = ticket.priority_name?.toLowerCase() || '';
                
                tableHTML += `
                    <tr onclick="viewTicket('${ticket.ticket_id}')" style="cursor: pointer;">
                        <td><strong>${ticket.ticket_id}</strong></td>
                        <td>${ticket.subject}</td>
                        <td><span class="status-badge" style="background: ${ticket.status_color || '#6c757d'}; color: white;">${ticket.status_name || 'Unknown'}</span></td>
                        <td><span class="priority-badge" style="background: ${ticket.priority_color || '#6c757d'}; color: white;">${ticket.priority_name || 'Unknown'}</span></td>
                        <td>${ticket.category_name || 'Uncategorized'}</td>
                        <td>${ticket.requester_name || 'Unknown'}</td>
                        <td>${ticket.assignee_name || 'Unassigned'}</td>
                        <td>${new Date(ticket.created_at).toLocaleDateString()}</td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table>';
            resultsTable.innerHTML = tableHTML;
        }

        // Clear all filters
        function clearFilters() {
            document.getElementById('searchText').value = '';
            document.getElementById('statusFilter').selectedIndex = 0;
            document.getElementById('priorityFilter').selectedIndex = 0;
            document.getElementById('categoryFilter').selectedIndex = 0;
            document.getElementById('assigneeFilter').selectedIndex = 0;
            document.getElementById('requesterFilter').selectedIndex = 0;
            document.getElementById('departmentFilter').selectedIndex = 0;
            document.getElementById('createdAfter').value = '';
            document.getElementById('createdBefore').value = '';
            document.getElementById('updatedAfter').value = '';
            document.getElementById('updatedBefore').value = '';
            document.getElementById('resolvedAfter').value = '';
            document.getElementById('resolvedBefore').value = '';
        }

        // Load saved filters
        async function loadSavedFilters() {
            try {
                const response = await fetch('/api/advanced-search/saved-filters', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    displaySavedFilters(data.filters);
                }
            } catch (error) {
                console.error('Error loading saved filters:', error);
            }
        }

        // Display saved filters
        function displaySavedFilters(filters) {
            const container = document.getElementById('savedFiltersList');
            
            if (filters.length === 0) {
                container.innerHTML = '<div style="color: #6c757d; font-style: italic;">No saved filters</div>';
                return;
            }

            let html = '';
            filters.forEach(filter => {
                html += `
                    <div class="saved-filter-item">
                        <div class="saved-filter-info">
                            <div class="saved-filter-name">${filter.name}</div>
                            <div class="saved-filter-desc">${filter.description || 'No description'}</div>
                        </div>
                        <div class="saved-filter-actions">
                            <button class="btn btn-primary btn-small" onclick="loadFilter(${filter.id})">Load</button>
                            <button class="btn btn-secondary btn-small" onclick="deleteFilter(${filter.id})">Delete</button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Load a saved filter
        async function loadFilter(filterId) {
            try {
                const response = await fetch(`/api/advanced-search/saved-filters/${filterId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    applyFilter(data.filter.filters);
                    performSearch();
                }
            } catch (error) {
                console.error('Error loading filter:', error);
            }
        }

        // Apply filter to form
        function applyFilter(filters) {
            // Clear current selections
            clearFilters();

            // Apply text search
            if (filters.search) {
                document.getElementById('searchText').value = filters.search;
            }

            // Apply status filter
            if (filters.status) {
                const statusSelect = document.getElementById('statusFilter');
                if (Array.isArray(filters.status)) {
                    filters.status.forEach(status => {
                        const option = Array.from(statusSelect.options).find(opt => opt.value === status);
                        if (option) option.selected = true;
                    });
                } else {
                    const option = Array.from(statusSelect.options).find(opt => opt.value === filters.status);
                    if (option) option.selected = true;
                }
            }

            // Apply other filters similarly...
            // (Priority, category, assignee, requester, department, dates)
        }

        // Delete a saved filter
        async function deleteFilter(filterId) {
            if (!confirm('Are you sure you want to delete this filter?')) return;

            try {
                const response = await fetch(`/api/advanced-search/saved-filters/${filterId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    loadSavedFilters();
                }
            } catch (error) {
                console.error('Error deleting filter:', error);
            }
        }

        // Show save filter modal
        function saveFilter() {
            document.getElementById('saveFilterModal').style.display = 'block';
        }

        // Close save filter modal
        function closeSaveModal() {
            document.getElementById('saveFilterModal').style.display = 'none';
            document.getElementById('filterName').value = '';
            document.getElementById('filterDescription').value = '';
            document.getElementById('filterPublic').checked = false;
        }

        // Confirm save filter
        async function confirmSaveFilter() {
            const name = document.getElementById('filterName').value.trim();
            if (!name) {
                alert('Please enter a filter name');
                return;
            }

            const filterData = {
                name: name,
                description: document.getElementById('filterDescription').value.trim(),
                filters: currentFilters,
                isPublic: document.getElementById('filterPublic').checked
            };

            try {
                const response = await fetch('/api/advanced-search/saved-filters', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(filterData)
                });

                if (response.ok) {
                    closeSaveModal();
                    loadSavedFilters();
                    alert('Filter saved successfully!');
                } else {
                    alert('Failed to save filter');
                }
            } catch (error) {
                console.error('Error saving filter:', error);
                alert('Error saving filter');
            }
        }

        // Export results
        async function exportResults(format) {
            if (!currentFilters || Object.keys(currentFilters).length === 0) {
                alert('Please perform a search first');
                return;
            }

            try {
                const response = await fetch('/api/advanced-search/export', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        filters: currentFilters,
                        format: format
                    })
                });

                if (response.ok) {
                    if (format === 'csv') {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `tickets-search-${new Date().toISOString().split('T')[0]}.csv`;
                        a.click();
                        window.URL.revokeObjectURL(url);
                    } else {
                        const data = await response.json();
                        const blob = new Blob([JSON.stringify(data.data, null, 2)], { type: 'application/json' });
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `tickets-search-${new Date().toISOString().split('T')[0]}.json`;
                        a.click();
                        window.URL.revokeObjectURL(url);
                    }
                }
            } catch (error) {
                console.error('Error exporting results:', error);
                alert('Error exporting results');
            }
        }

        // View ticket details
        function viewTicket(ticketId) {
            window.open(`/client?ticket=${ticketId}`, '_blank');
        }

        // Close modal when clicking outside
        document.getElementById('saveFilterModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeSaveModal();
            }
        });
    </script>
</body>
</html> 