<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Reports & Analytics - IT Support System</title>
    <link rel="stylesheet" href="html.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .reports-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .reports-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }

        .reports-header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }

        .reports-header p {
            margin: 10px 0 0 0;
            font-size: 1.1em;
            opacity: 0.9;
        }

        .controls-panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-weight: 600;
            color: #555;
            font-size: 0.9em;
        }

        .control-group select {
            padding: 8px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(40, 167, 69, 0.4);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .metric-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .metric-label {
            color: #6c757d;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .metric-change {
            font-size: 0.8em;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 600;
        }

        .metric-change.positive {
            background: #d4edda;
            color: #155724;
        }

        .metric-change.negative {
            background: #f8d7da;
            color: #721c24;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f8f9fa;
        }

        .chart-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .chart-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.8em;
        }

        .reports-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: #f8f9fa;
            color: #6c757d;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab-btn:hover {
            background: #e9ecef;
        }

        .tab-btn.active:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .performance-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .performance-table th,
        .performance-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .performance-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .performance-table tr:hover {
            background: #f8f9fa;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #dc3545;
        }

        .refresh-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            z-index: 1000;
            display: none;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .controls-panel {
                flex-direction: column;
                align-items: stretch;
            }
            
            .reports-tabs {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="reports-container">
        <!-- Header -->
        <div class="reports-header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>üìä Enhanced Reports & Analytics</h1>
                    <p>Comprehensive insights into ticket management, SLA compliance, and team performance</p>
                </div>
                <a href="/admin-users" class="btn btn-primary" style="text-decoration: none;">
                    ‚Üê Back to Admin
                </a>
            </div>
        </div>

        <!-- Controls Panel -->
        <div class="controls-panel">
            <div class="control-group">
                <label>Time Range</label>
                <select id="timeRange">
                    <option value="7d">Last 7 Days</option>
                    <option value="30d" selected>Last 30 Days</option>
                    <option value="90d">Last 90 Days</option>
                </select>
            </div>
            <div class="control-group">
                <label>Report Type</label>
                <select id="reportType">
                    <option value="overview" selected>Overview Dashboard</option>
                    <option value="ticket-volume">Ticket Volume</option>
                    <option value="sla-compliance">SLA Compliance</option>
                    <option value="technician-performance">Technician Performance</option>
                    <option value="category-priority">Category & Priority</option>
                    <option value="resolution-time">Resolution Time</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="loadReports()">
                üîÑ Refresh Reports
            </button>
            <button class="btn btn-success" onclick="exportCurrentReport()">
                üìÑ Export Report
            </button>
        </div>

        <!-- Tabs -->
        <div class="reports-tabs">
            <button class="tab-btn active" onclick="showTab('overview')">üìà Overview</button>
            <button class="tab-btn" onclick="showTab('volume')">üìä Volume Trends</button>
            <button class="tab-btn" onclick="showTab('sla')">‚è∞ SLA Compliance</button>
            <button class="tab-btn" onclick="showTab('performance')">üë• Performance</button>
            <button class="tab-btn" onclick="showTab('analytics')">üîç Analytics</button>
        </div>

        <!-- Overview Tab -->
        <div id="overview" class="tab-content active">
            <!-- Real-time Metrics -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-value" id="ticketsToday">-</div>
                    <div class="metric-label">Tickets Today</div>
                    <div class="metric-change positive" id="ticketsChange">+0%</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="openTickets">-</div>
                    <div class="metric-label">Open Tickets</div>
                    <div class="metric-change" id="openChange">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="resolvedToday">-</div>
                    <div class="metric-label">Resolved Today</div>
                    <div class="metric-change positive" id="resolvedChange">+0%</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="slaCompliance">-</div>
                    <div class="metric-label">SLA Compliance</div>
                    <div class="metric-change" id="slaChange">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="unassignedTickets">-</div>
                    <div class="metric-label">Unassigned</div>
                    <div class="metric-change" id="unassignedChange">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="highPriorityTickets">-</div>
                    <div class="metric-label">High Priority</div>
                    <div class="metric-change" id="priorityChange">-</div>
                </div>
            </div>

            <!-- Charts Grid -->
            <div class="charts-grid">
                <!-- Trend Analysis Chart -->
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">üìà Ticket Trends (Last 7 Days)</h3>
                        <div class="chart-actions">
                            <button class="btn btn-small btn-primary" onclick="refreshTrendChart()">Refresh</button>
                        </div>
                    </div>
                    <canvas id="trendChart" width="400" height="200"></canvas>
                </div>

                <!-- SLA Compliance Chart -->
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">‚è∞ SLA Compliance by Priority</h3>
                        <div class="chart-actions">
                            <button class="btn btn-small btn-primary" onclick="refreshSLAChart()">Refresh</button>
                        </div>
                    </div>
                    <canvas id="slaChart" width="400" height="200"></canvas>
                </div>

                <!-- Category Distribution Chart -->
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">üìÇ Category Distribution</h3>
                        <div class="chart-actions">
                            <button class="btn btn-small btn-primary" onclick="refreshCategoryChart()">Refresh</button>
                        </div>
                    </div>
                    <canvas id="categoryChart" width="400" height="200"></canvas>
                </div>

                <!-- Top Technicians Chart -->
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">üèÜ Top Performing Technicians</h3>
                        <div class="chart-actions">
                            <button class="btn btn-small btn-primary" onclick="refreshTechniciansChart()">Refresh</button>
                        </div>
                    </div>
                    <canvas id="techniciansChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- Volume Trends Tab -->
        <div id="volume" class="tab-content">
            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="chart-title">üìä Ticket Volume Trends</h3>
                    <div class="chart-actions">
                        <select id="volumeGroupBy" onchange="refreshVolumeChart()">
                            <option value="day">Daily</option>
                            <option value="week">Weekly</option>
                            <option value="month">Monthly</option>
                        </select>
                        <button class="btn btn-small btn-primary" onclick="refreshVolumeChart()">Refresh</button>
                    </div>
                </div>
                <canvas id="volumeChart" width="800" height="400"></canvas>
            </div>
        </div>

        <!-- SLA Compliance Tab -->
        <div id="sla" class="tab-content">
            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="chart-title">‚è∞ SLA Compliance Analysis</h3>
                    <div class="chart-actions">
                        <button class="btn btn-small btn-primary" onclick="refreshSLAComplianceChart()">Refresh</button>
                    </div>
                </div>
                <canvas id="slaComplianceChart" width="800" height="400"></canvas>
            </div>
        </div>

        <!-- Performance Tab -->
        <div id="performance" class="tab-content">
            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="chart-title">üë• Technician Performance</h3>
                    <div class="chart-actions">
                        <button class="btn btn-small btn-primary" onclick="refreshPerformanceTable()">Refresh</button>
                    </div>
                </div>
                <div id="performanceTable">
                    <div class="loading">Loading performance data...</div>
                </div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics" class="tab-content">
            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">‚è±Ô∏è Resolution Time Analytics</h3>
                        <div class="chart-actions">
                            <button class="btn btn-small btn-primary" onclick="refreshResolutionChart()">Refresh</button>
                        </div>
                    </div>
                    <canvas id="resolutionChart" width="400" height="200"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">üìà Customer Satisfaction</h3>
                        <div class="chart-actions">
                            <button class="btn btn-small btn-primary" onclick="refreshSatisfactionChart()">Refresh</button>
                        </div>
                    </div>
                    <canvas id="satisfactionChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Refresh Indicator -->
    <div class="refresh-indicator" id="refreshIndicator">
        üîÑ Reports updated successfully!
    </div>

    <script>
        let charts = {};
        let currentTimeRange = '30d';
        let currentReportType = 'overview';

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadReports();
            // Auto-refresh every 5 minutes
            setInterval(loadReports, 5 * 60 * 1000);
        });

        // Show tab content
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            // Load data for the tab
            loadTabData(tabName);
        }

        // Load data for specific tab
        function loadTabData(tabName) {
            switch(tabName) {
                case 'overview':
                    loadOverviewData();
                    break;
                case 'volume':
                    loadVolumeData();
                    break;
                case 'sla':
                    loadSLAData();
                    break;
                case 'performance':
                    loadPerformanceData();
                    break;
                case 'analytics':
                    loadAnalyticsData();
                    break;
            }
        }

        // Load all reports
        async function loadReports() {
            try {
                // Show loading state
                showLoading(true);
                
                currentTimeRange = document.getElementById('timeRange').value;
                currentReportType = document.getElementById('reportType').value;
                
                await loadOverviewData();
                showRefreshIndicator();
            } catch (error) {
                console.error('Error loading reports:', error);
                showError('Failed to load reports: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Load overview data
        async function loadOverviewData() {
            try {
                const response = await fetch(`/api/enhanced-reports/real-time-dashboard`, {
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    updateMetrics(data.metrics);
                    updateTrendChart(data.trendAnalysis);
                    updateSLAChart();
                    updateCategoryChart();
                    updateTechniciansChart(data.topTechnicians);
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('Error loading overview data:', error);
                showError('Failed to load overview data: ' + error.message);
            }
        }

        // Update metrics
        function updateMetrics(metrics) {
            document.getElementById('ticketsToday').textContent = metrics.tickets_today || 0;
            document.getElementById('openTickets').textContent = metrics.open_tickets || 0;
            document.getElementById('resolvedToday').textContent = metrics.resolved_today || 0;
            document.getElementById('unassignedTickets').textContent = metrics.unassigned_tickets || 0;
            document.getElementById('highPriorityTickets').textContent = metrics.high_priority_tickets || 0;

            // Calculate SLA compliance
            const slaCompliance = metrics.resolved_today > 0 ? 
                Math.round((metrics.resolved_today / (metrics.tickets_today + metrics.resolved_today)) * 100) : 0;
            document.getElementById('slaCompliance').textContent = slaCompliance + '%';

            // Update change indicators
            const yesterdayChange = metrics.tickets_yesterday > 0 ? 
                Math.round(((metrics.tickets_today - metrics.tickets_yesterday) / metrics.tickets_yesterday) * 100) : 0;
            
            const ticketsChange = document.getElementById('ticketsChange');
            ticketsChange.textContent = (yesterdayChange >= 0 ? '+' : '') + yesterdayChange + '%';
            ticketsChange.className = 'metric-change ' + (yesterdayChange >= 0 ? 'positive' : 'negative');
        }

        // Update trend chart
        function updateTrendChart(trendData) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            if (charts.trendChart) {
                charts.trendChart.destroy();
            }

            charts.trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: trendData.map(item => item.date),
                    datasets: [{
                        label: 'Created',
                        data: trendData.map(item => item.created),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Resolved',
                        data: trendData.map(item => item.resolved),
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Update SLA chart
        async function updateSLAChart() {
            try {
                const response = await fetch(`/api/enhanced-reports/sla-compliance?timeRange=${currentTimeRange}`, {
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    const ctx = document.getElementById('slaChart').getContext('2d');
                    
                    if (charts.slaChart) {
                        charts.slaChart.destroy();
                    }

                    charts.slaChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: data.report.map(item => item.priority),
                            datasets: [{
                                label: 'SLA Compliant',
                                data: data.report.map(item => item.sla_compliant),
                                backgroundColor: '#28a745'
                            }, {
                                label: 'SLA Violations',
                                data: data.report.map(item => item.total_tickets - item.sla_compliant),
                                backgroundColor: '#dc3545'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top'
                                }
                            },
                            scales: {
                                x: {
                                    stacked: true
                                },
                                y: {
                                    stacked: true,
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error updating SLA chart:', error);
            }
        }

        // Update category chart
        async function updateCategoryChart() {
            try {
                const response = await fetch(`/api/enhanced-reports/category-priority-distribution?timeRange=${currentTimeRange}`, {
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    const ctx = document.getElementById('categoryChart').getContext('2d');
                    
                    if (charts.categoryChart) {
                        charts.categoryChart.destroy();
                    }

                    // Process data for pie chart
                    const categories = {};
                    data.rawData.forEach(item => {
                        if (!categories[item.category]) {
                            categories[item.category] = 0;
                        }
                        categories[item.category] += item.ticket_count;
                    });

                    charts.categoryChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: Object.keys(categories),
                            datasets: [{
                                data: Object.values(categories),
                                backgroundColor: [
                                    '#667eea',
                                    '#764ba2',
                                    '#f093fb',
                                    '#f5576c',
                                    '#4facfe',
                                    '#00f2fe'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error updating category chart:', error);
            }
        }

        // Update technicians chart
        function updateTechniciansChart(technicians) {
            const ctx = document.getElementById('techniciansChart').getContext('2d');
            
            if (charts.techniciansChart) {
                charts.techniciansChart.destroy();
            }

            charts.techniciansChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: technicians.map(tech => tech.technician_name),
                    datasets: [{
                        label: 'Resolved Tickets',
                        data: technicians.map(tech => tech.total_resolved),
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Load volume data
        async function loadVolumeData() {
            try {
                const groupBy = document.getElementById('volumeGroupBy').value;
                const response = await fetch(`/api/enhanced-reports/ticket-volume?timeRange=${currentTimeRange}&groupBy=${groupBy}`, {
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    updateVolumeChart(data.report);
                }
            } catch (error) {
                console.error('Error loading volume data:', error);
            }
        }

        // Update volume chart
        function updateVolumeChart(volumeData) {
            const ctx = document.getElementById('volumeChart').getContext('2d');
            
            if (charts.volumeChart) {
                charts.volumeChart.destroy();
            }

            charts.volumeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: volumeData.map(item => item.period),
                    datasets: [{
                        label: 'Total Tickets',
                        data: volumeData.map(item => item.total_tickets),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Open Tickets',
                        data: volumeData.map(item => item.open_tickets),
                        borderColor: '#ffc107',
                        backgroundColor: 'rgba(255, 193, 7, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Resolved Tickets',
                        data: volumeData.map(item => item.resolved_tickets),
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Load SLA data
        async function loadSLAData() {
            try {
                const response = await fetch(`/api/enhanced-reports/sla-compliance?timeRange=${currentTimeRange}`, {
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    updateSLAComplianceChart(data.report);
                }
            } catch (error) {
                console.error('Error loading SLA data:', error);
            }
        }

        // Update SLA compliance chart
        function updateSLAComplianceChart(slaData) {
            const ctx = document.getElementById('slaComplianceChart').getContext('2d');
            
            if (charts.slaComplianceChart) {
                charts.slaComplianceChart.destroy();
            }

            charts.slaComplianceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: slaData.map(item => item.priority),
                    datasets: [{
                        label: 'Compliance Rate (%)',
                        data: slaData.map(item => item.compliance_rate),
                        backgroundColor: slaData.map(item => 
                            item.compliance_rate >= 90 ? '#28a745' :
                            item.compliance_rate >= 75 ? '#ffc107' : '#dc3545'
                        )
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        // Load performance data
        async function loadPerformanceData() {
            try {
                const response = await fetch(`/api/enhanced-reports/technician-performance?timeRange=${currentTimeRange}`, {
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    updatePerformanceTable(data.report);
                }
            } catch (error) {
                console.error('Error loading performance data:', error);
            }
        }

        // Update performance table
        function updatePerformanceTable(performanceData) {
            const container = document.getElementById('performanceTable');
            
            if (performanceData.length === 0) {
                container.innerHTML = '<div class="no-data">No performance data available</div>';
                return;
            }

            let tableHTML = `
                <table class="performance-table">
                    <thead>
                        <tr>
                            <th>Technician</th>
                            <th>Total Assigned</th>
                            <th>Resolved</th>
                            <th>Resolution Rate</th>
                            <th>Avg Resolution (hrs)</th>
                            <th>SLA Compliance</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            performanceData.forEach(tech => {
                const resolutionRate = tech.total_assigned > 0 ? 
                    Math.round((tech.resolved_tickets / tech.total_assigned) * 100) : 0;
                const slaCompliance = tech.resolved_tickets > 0 ? 
                    Math.round((tech.sla_compliant_tickets / tech.resolved_tickets) * 100) : 0;

                tableHTML += `
                    <tr>
                        <td><strong>${tech.technician_name}</strong><br><small>${tech.technician_email}</small></td>
                        <td>${tech.total_assigned}</td>
                        <td>${tech.resolved_tickets}</td>
                        <td>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${resolutionRate}%"></div>
                            </div>
                            <small>${resolutionRate}%</small>
                        </td>
                        <td>${tech.avg_resolution_hours || 0}</td>
                        <td>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${slaCompliance}%"></div>
                            </div>
                            <small>${slaCompliance}%</small>
                        </td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
        }

        // Load analytics data
        async function loadAnalyticsData() {
            try {
                await Promise.all([
                    loadResolutionData(),
                    loadSatisfactionData()
                ]);
            } catch (error) {
                console.error('Error loading analytics data:', error);
            }
        }

        // Load resolution data
        async function loadResolutionData() {
            try {
                const response = await fetch(`/api/enhanced-reports/resolution-time-analytics?timeRange=${currentTimeRange}`, {
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    updateResolutionChart(data.report);
                }
            } catch (error) {
                console.error('Error loading resolution data:', error);
            }
        }

        // Update resolution chart
        function updateResolutionChart(resolutionData) {
            const ctx = document.getElementById('resolutionChart').getContext('2d');
            
            if (charts.resolutionChart) {
                charts.resolutionChart.destroy();
            }

            // Group by priority
            const priorities = {};
            resolutionData.forEach(item => {
                if (!priorities[item.priority]) {
                    priorities[item.priority] = [];
                }
                priorities[item.priority].push(item.avg_resolution_hours);
            });

            charts.resolutionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(priorities),
                    datasets: [{
                        label: 'Avg Resolution Time (hrs)',
                        data: Object.values(priorities).map(avg => 
                            avg.reduce((a, b) => a + b, 0) / avg.length
                        ),
                        backgroundColor: ['#667eea', '#764ba2', '#f093fb', '#f5576c']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Load satisfaction data
        async function loadSatisfactionData() {
            try {
                const response = await fetch(`/api/enhanced-reports/customer-satisfaction?timeRange=${currentTimeRange}`, {
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    updateSatisfactionChart(data.report);
                }
            } catch (error) {
                console.error('Error loading satisfaction data:', error);
            }
        }

        // Update satisfaction chart
        function updateSatisfactionChart(satisfactionData) {
            const ctx = document.getElementById('satisfactionChart').getContext('2d');
            
            if (charts.satisfactionChart) {
                charts.satisfactionChart.destroy();
            }

            charts.satisfactionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['SLA Compliant', 'SLA Violations'],
                    datasets: [{
                        data: [
                            satisfactionData.sla_compliant_tickets,
                            satisfactionData.tickets_with_resolution - satisfactionData.sla_compliant_tickets
                        ],
                        backgroundColor: ['#28a745', '#dc3545']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Refresh functions for individual charts
        function refreshTrendChart() {
            loadOverviewData();
        }

        function refreshSLAChart() {
            updateSLAChart();
        }

        function refreshCategoryChart() {
            updateCategoryChart();
        }

        function refreshTechniciansChart() {
            loadOverviewData();
        }

        function refreshVolumeChart() {
            loadVolumeData();
        }

        function refreshSLAComplianceChart() {
            loadSLAData();
        }

        function refreshPerformanceTable() {
            loadPerformanceData();
        }

        function refreshResolutionChart() {
            loadResolutionData();
        }

        function refreshSatisfactionChart() {
            loadSatisfactionData();
        }

        // Export current report
        async function exportCurrentReport() {
            try {
                const reportType = document.getElementById('reportType').value;
                const timeRange = document.getElementById('timeRange').value;
                
                // Map frontend report types to API report types
                const apiReportType = reportType === 'overview' ? 'ticket-volume' : reportType;
                
                const response = await fetch(`/api/enhanced-reports/export?reportType=${apiReportType}&timeRange=${timeRange}&format=csv`, {
                    method: 'POST',
                    credentials: 'include'
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${reportType}-${timeRange}-${new Date().toISOString().split('T')[0]}.csv`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                }
            } catch (error) {
                console.error('Error exporting report:', error);
                alert('Error exporting report');
            }
        }

        // Show refresh indicator
        function showRefreshIndicator() {
            const indicator = document.getElementById('refreshIndicator');
            indicator.style.display = 'block';
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 3000);
        }

        // Show loading state
        function showLoading(show) {
            const loadingElements = document.querySelectorAll('.loading');
            loadingElements.forEach(el => {
                el.style.display = show ? 'block' : 'none';
            });
            
            // Disable/enable buttons during loading
            const buttons = document.querySelectorAll('.btn');
            buttons.forEach(btn => {
                btn.disabled = show;
                if (show) {
                    btn.style.opacity = '0.6';
                } else {
                    btn.style.opacity = '1';
                }
            });
        }

        // Show error
        function showError(message) {
            console.error(message);
            // Show error in a more visible way
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #dc3545;
                color: white;
                padding: 15px 20px;
                border-radius: 5px;
                z-index: 1000;
                max-width: 300px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            `;
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
            
            // Remove after 5 seconds
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 5000);
        }
    </script>
</body>
</html> 